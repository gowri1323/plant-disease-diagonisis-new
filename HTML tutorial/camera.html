<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Camera Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Scanning line animation */
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: rgba(0, 255, 0, 0.7);
            animation: move 3s infinite;
        }
        @keyframes move {
            0% { top: 0; }
            100% { top: 100%; }
        }
        .button-link {
            display: inline-block;
            padding: 10px 20px;
            background-color: #74c67e; /* Button background color */
            color: white; /* Text color */
            text-align: center;
            text-decoration: none;
            border-radius: 5px; /* Rounded corners */
            font-size: 16px; /* Font size */
            transition: background-color 0.3s ease; /* Smooth hover effect */
            border: none;
            margin-top:3rem;
        }
        .button-link:hover{
            background-color: #aeddbb;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Scan with Camera</h1>

    <!-- Camera video container -->
    <div class="relative w-full max-w-lg bg-gray-800 rounded-lg overflow-hidden shadow-md">
        <video id="video" class="w-full h-64 object-cover" autoplay></video>
        <div class="scanner-line"></div> <!-- Scanning line effect -->
        <div class="absolute bottom-4 left-4 flex space-x-4">
            <!-- Switch Camera Button -->
            <button id="switchCamera" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 focus:outline-none">
                Switch Camera
            </button>

            <!-- Capture Picture Button -->
            <button id="capture" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 focus:outline-none">
                Capture Picture
            </button>

            <!-- Access Gallery Button -->
            <button id="galleryButton" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 focus:outline-none">
                Access Gallery
            </button>
        </div>
    </div>

    <!-- Image Preview after capture or from gallery -->
    <div id="imagePreview" class="mt-6">
        <h2 class="text-xl font-bold text-gray-700 mb-4">Selected/Captured Image:</h2>
        <canvas id="canvas" class="border border-gray-500 hidden"></canvas>
        <img id="selectedImage" class="hidden w-full max-w-lg rounded-lg shadow-md mt-4" alt="Selected Image" />
    </div>

    <!-- Question Form (hidden by default) -->
    <div id="questionForm" class="hidden mt-6 w-full max-w-lg bg-white p-4 rounded-lg shadow-md">
        <h3 class="text-2xl font-semibold mb-4">Additional Information</h3>
        <form id="infoForm">
            <label for="affectedArea" class="block mb-2 text-gray-700">How much area is affected?</label>
            <input type="text" id="affectedArea" class="w-full px-3 py-2 mb-4 border border-gray-300 rounded-lg" placeholder="Enter area in sq meters">

            <label for="previousTreatment" class="block mb-2 text-gray-700">What treatments did you give previously?</label>
            <input type="text" id="previousTreatment" class="w-full px-3 py-2 mb-4 border border-gray-300 rounded-lg" placeholder="Enter previous treatments">

            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Proceed</button>
        </form>
    </div>

    <!-- Hidden input for accessing gallery -->
    <input type="file" id="galleryInput" accept="image/*" class="hidden">
    <div class="back-link">
        <a href="explore.html" class="button-link">Back to explore</a>
    </div>

    <script>
        let video = document.getElementById('video');
        let switchCamera = document.getElementById('switchCamera');
        let captureButton = document.getElementById('capture');
        let galleryButton = document.getElementById('galleryButton');
        let galleryInput = document.getElementById('galleryInput');
        let canvas = document.getElementById('canvas');
        let imagePreview = document.getElementById('imagePreview');
        let questionForm = document.getElementById('questionForm');
        let selectedImage = document.getElementById('selectedImage');
        let currentStream = null;
        let isFrontCamera = false; // Default to back camera

        // Function to stop the current stream
        function stopStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        }

        // Function to start the camera stream with facing mode
        function startCamera(facingMode = 'environment') {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                stopStream();
                navigator.mediaDevices.getUserMedia({ video: { facingMode } })
                    .then(function(stream) {
                        video.srcObject = stream;
                        currentStream = stream;
                    })
                    .catch(function(error) {
                        console.error('Error accessing the camera: ', error);
                    });
            } else {
                console.error('getUserMedia is not supported in this browser.');
            }
        }

        // Start camera with back camera by default
        startCamera();

        // Event to switch between front and rear cameras
        switchCamera.addEventListener('click', () => {
            isFrontCamera = !isFrontCamera;
            const facingMode = isFrontCamera ? 'user' : 'environment';
            startCamera(facingMode);
        });

        // Capture image from video stream and show the form
        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            let context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.classList.remove('hidden'); // Show the captured image

            // Hide any previously selected image
            selectedImage.classList.add('hidden');

            // Show the question form
            questionForm.classList.remove('hidden');
        });

        // Open gallery when gallery button is clicked
        galleryButton.addEventListener('click', () => {
            galleryInput.click();
        });

        // Handle files selected from the gallery
        galleryInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImage.src = e.target.result;
                    selectedImage.classList.remove('hidden'); // Show the selected image
                    canvas.classList.add('hidden'); // Hide the canvas

                    // Show the question form
                    questionForm.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle form submission
        document.getElementById('infoForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const affectedArea = document.getElementById('affectedArea').value;
            const previousTreatment = document.getElementById('previousTreatment').value;

            console.log('Affected Area:', affectedArea);
            console.log('Previous Treatment:', previousTreatment);

            // You can process this data further or send it to the server
            alert('Information submitted!');
        });
    </script>
</body>
</html>